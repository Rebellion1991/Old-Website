{{ if .Site.Params.contact.formspree.enable | default false }}
<script>
// FormSpree form handling with accessibility improvements
async function handleFormspreeSubmit(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  const statusContainer = document.getElementById('contact-form-status');
  const submitButton = form.querySelector('button[type="submit"]');
  
  // Disable the submit button and show loading state
  submitButton.disabled = true;
  submitButton.setAttribute('aria-busy', 'true');
  submitButton.innerHTML = 'Sending...';
  
  try {
    const response = await fetch(form.action, {
      method: form.method,
      body: formData,
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (response.ok) {
      // Success message with accessibility
      statusContainer.innerHTML = `
        <div class="alert alert-success d-flex align-items-center" role="alert" aria-live="polite">
          <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:">
            <use xlink:href="#check-circle-fill"/>
          </svg>
          <div>
            Thank you for your message! I'll get back to you soon.
          </div>
        </div>
      `;
      form.reset();
    } else {
      // Error handling
      const data = await response.json();
      if (data.errors) {
        // Validation errors
        statusContainer.innerHTML = `
          <div class="alert alert-danger d-flex align-items-center" role="alert" aria-live="assertive">
            <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Error:">
              <use xlink:href="#exclamation-triangle-fill"/>
            </svg>
            <div>
              ${data.errors.map(error => error.message).join(', ')}
            </div>
          </div>
        `;
      } else {
        // Generic error
        statusContainer.innerHTML = `
          <div class="alert alert-danger d-flex align-items-center" role="alert" aria-live="assertive">
            <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Error:">
              <use xlink:href="#exclamation-triangle-fill"/>
            </svg>
            <div>
              Oops! There was a problem submitting your form. Please try again.
            </div>
          </div>
        `;
      }
    }
  } catch (error) {
    console.error("Form submission error:", error);
    // Network error
    statusContainer.innerHTML = `
      <div class="alert alert-danger d-flex align-items-center" role="alert" aria-live="assertive">
        <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Error:">
          <use xlink:href="#exclamation-triangle-fill"/>
        </svg>
        <div>
          Network error. Please check your connection and try again.
        </div>
      </div>
    `;
  } finally {
    // Re-enable the submit button
    submitButton.disabled = false;
    submitButton.removeAttribute('aria-busy');
    submitButton.innerHTML = '{{ .Site.Params.contact.btnName | default "Send Message" }}';
    
    // Scroll to status message
    statusContainer.scrollIntoView({ behavior: 'smooth' });
  }
}

// Initialize form handling when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
  const contactForm = document.getElementById('contact-form');
  const statusContainer = document.getElementById('contact-form-status');
  
  if (contactForm) {
    console.log("Contact form found, initializing...");
    // Attach the event listener directly to the form
    contactForm.addEventListener('submit', function(event) {
      handleFormspreeSubmit(event);
    });
    
    // Clear any previous error messages
    if (statusContainer) {
      statusContainer.innerHTML = '';
    }
  } else {
    console.error("Contact form not found!");
    if (statusContainer) {
      statusContainer.innerHTML = `
        <div class="alert alert-danger d-flex align-items-center" role="alert" aria-live="assertive">
          <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Error:">
            <use xlink:href="#exclamation-triangle-fill"/>
          </svg>
          <div>
            Form configuration error. Please check your setup.
          </div>
        </div>
      `;
    }
  }
});
</script>
{{ end }}
